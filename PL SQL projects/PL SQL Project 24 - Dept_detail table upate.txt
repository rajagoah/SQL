
/*DEPARTMENT TABLE  --> DEPARTMENT_ID / NAME / LOCATION 
  EMPLOYEE TABLE    --> DEPARTMENT_ID / SALARY / EMPLOYEE_ID */

--QUERY THAT WILL BE USED IN PL/SQL
SELECT
COALESCE(B.DEPARTMENT_ID,0) AS DEPARTMENT_ID
, COALESCE(B.NAME,'EXEC') AS DEPARTMENT_NAME
, COUNT(EMPLOYEE_ID) AS EMPS_PER_DEP
, SUM(SALARY) AS SUMSAL_PER_DEP
, CURRENT_TIMESTAMP AS LAST_LOAD_TS
FROM EMPLOYEE A
LEFT OUTER JOIN DEPARTMENT B
ON A.DEPARTMENT_ID = B.DEPARTMENT_ID
GROUP BY B.DEPARTMENT_ID, B.NAME;

--CREATING TARGET TABLE WITH ABOVE QUERY STRUCTURE
CREATE TABLE DEPT_DETAIL
( DEPARTMENT_ID NUMBER NOT NULL
, DEPARTMENT_NAME VARCHAR(20) NOT NULL
, EMPS_PER_DEP NUMBER
, SUMSAL_PER_DEP NUMBER
, LAST_LOAD_TS TIMESTAMP NOT NULL
, CONSTRAINT DEPT_DETAIL_PK PRIMARY KEY (DEPARTMENT_ID));
SET SERVEROUTPUT ON
DECLARE     
    --DECLARATION OF FLAG VARIABLES
    INS_FLAG CHAR(1);
    UPD_FLAG CHAR(1);
    
    --DECLARATION OF CUROSR FOR CHECKING IF RECORDS EXIST IN TARGET TABLE
    CURSOR C1 IS 
        SELECT 
        B.DEPARTMENT_ID AS TGT_DEPT_ID
        FROM DEPARTMENT A 
        LEFT OUTER JOIN DEPT_DETAIL B
        ON A.DEPARTMENT_ID = b.department_id;
    V_ROW1 C1%ROWTYPE;
    
    --DECLARATION OF CURSOR FOR UPDATING RECORDS IN TARGET TABLE 
    CURSOR C2 IS
        SELECT
        COALESCE(B.DEPARTMENT_ID,0) AS DEPARTMENT_ID
        , COALESCE(B.NAME,'EXEC') AS DEPARTMENT_NAME
        , COUNT(EMPLOYEE_ID) AS EMPS_PER_DEP
        , SUM(SALARY) AS SUMSAL_PER_DEP
        , CURRENT_TIMESTAMP AS LAST_LOAD_TS
        FROM EMPLOYEE A
        LEFT OUTER JOIN DEPARTMENT B
        ON A.DEPARTMENT_ID = B.DEPARTMENT_ID
        GROUP BY B.DEPARTMENT_ID, B.NAME;
    V_ROW2 C2%ROWTYPE; 
    
    
BEGIN

    --OPENING CURSOR C1   
    OPEN C1;
        FETCH C1 INTO V_ROW1;
    CLOSE C1;
    
    -- SETTING THE INSERT FLAG/UPDATE FLAG TO DECIDE IF IT WILL BE AN INSERT OR AN UPDATE.
    IF V_ROW1.TGT_DEPT_ID IS NULL 
        THEN INS_FLAG := 'T';
        DBMS_OUTPUT.PUT_LINE('INSERT_FLAG ' ||INS_FLAG);
    ELSE 
        UPD_FLAG := 'T'; 
        DBMS_OUTPUT.PUT_LINE('UPDATE FLAG ' ||UPD_FLAG);
    END IF;
        
    --IF CONDITION TO ROUTE TO INSERT OP
    IF INS_FLAG = 'T' THEN
        INSERT INTO DEPT_DETAIL 
        (DEPARTMENT_ID
        , DEPARTMENT_NAME 
        , EMPS_PER_DEP
        , SUMSAL_PER_DEP
        , LAST_LOAD_TS)
            SELECT
            COALESCE(B.DEPARTMENT_ID,0) AS DEPARTMENT_ID
            , COALESCE(B.NAME,'EXEC') AS DEPARTMENT_NAME
            , COUNT(EMPLOYEE_ID) AS EMPS_PER_DEP
            , SUM(SALARY) AS SUMSAL_PER_DEP
            , CURRENT_TIMESTAMP AS LAST_LOAD_TS
            FROM EMPLOYEE A
            LEFT OUTER JOIN DEPARTMENT B
            ON A.DEPARTMENT_ID = B.DEPARTMENT_ID
            GROUP BY B.DEPARTMENT_ID, B.NAME;
    
    --ELSIF CONDITION TO ROUTE TO UPDATE OP 
    ELSIF UPD_FLAG = 'T' THEN
        --UPDATE STATEMENT FOR UPDATING INTO TARGET TABLE
        MERGE INTO DEPT_DETAIL TGT
        USING (SELECT
                 COALESCE(B.DEPARTMENT_ID,0) AS DEPARTMENT_ID
                 , COALESCE(B.NAME,'EXEC') AS DEPARTMENT_NAME
                 , COUNT(EMPLOYEE_ID) AS EMPS_PER_DEP
                 , SUM(SALARY) AS SUMSAL_PER_DEP
                 , CURRENT_TIMESTAMP AS LAST_LOAD_TS
                 FROM EMPLOYEE A
                 LEFT OUTER JOIN DEPARTMENT B
                 ON A.DEPARTMENT_ID = B.DEPARTMENT_ID
                 GROUP BY B.DEPARTMENT_ID, B.NAME) SRC
        ON (TGT.DEPARTMENT_ID = SRC.DEPARTMENT_ID)
        WHEN MATCHED THEN
        UPDATE SET
             TGT.DEPARTMENT_NAME = SRC.DEPARTMENT_NAME
            , TGT.EMPS_PER_DEP = SRC.EMPS_PER_DEP
            , TGT.SUMSAL_PER_DEP = SRC.SUMSAL_PER_DEP
            , TGT.LAST_LOAD_TS = CURRENT_TIMESTAMP;                             
    END IF;    
END;
    



