DROP TABLE EMP_SAL_MAX;

CREATE TABLE EMP_SAL_MAX
(CREATED_DATE TIMESTAMP
, DEPARTMENT CHAR(3)
, MAX_SALARY NUMBER
, LAST_LOAD_TS TIMESTAMP);


DECLARE
    CURSOR C1 IS
        SELECT 
        COALESCE(CAST(DEPARTMENT_ID AS CHAR(3)),'CEO') AS DEPARTMENT
        , MAX(SALARY) AS MAX_SALARY 
        FROM EMPLOYEE
        GROUP BY DEPARTMENT_ID
        ORDER BY DEPARTMENT_ID ASC;    
    V_ROW C1%ROWTYPE;
    
    CURSOR C2 IS
        SELECT 
        DEPARTMENT, MAX_SALARY
        FROM EMP_SAL_MAX;    
    V_ROW_2 C2%ROWTYPE;
    
    CURSOR C3 IS
        SELECT 
        COUNT(*) AS CNT 
        FROM EMP_SAL_MAX;
    V_ROW_3 NUMBER;

BEGIN
    OPEN C3;
        FETCH C3 INTO V_ROW_3;
    CLOSE C3;
    BEGIN   
        IF V_ROW_3 = 0
        THEN
            OPEN C1;
                LOOP
                    FETCH C1 INTO V_ROW;
                    EXIT WHEN C1%NOTFOUND;
                    BEGIN
                        INSERT INTO EMP_SAL_MAX VALUES
                        (CURRENT_TIMESTAMP 
                        , V_ROW.DEPARTMENT
                        , V_ROW.MAX_SALARY
                        , CURRENT_TIMESTAMP);
                    END;
                END LOOP;
            CLOSE C1;
        ELSE
        OPEN C2;
        LOOP
            FETCH C2 INTO V_ROW_2;
            EXIT WHEN C2%NOTFOUND;
            BEGIN
                UPDATE EMP_SAL_MAX A
                SET 
                A.DEPARTMENT = V_ROW_2.DEPARTMENT
                , A.MAX_SALARY = V_ROW_2.MAX_SALARY
                , A.LAST_LOAD_TS = CURRENT_TIMESTAMP;
            END;
        END LOOP;
        DBMS_OUTPUT.PUT_LINE('NO RECORDS IN THE TARGET TABLE');
        CLOSE C2;
        END IF;
    END;
    
END;

SELECT * FROM EMP_SAL_MAX;