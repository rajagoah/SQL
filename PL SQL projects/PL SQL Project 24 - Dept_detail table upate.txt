
/*DEPARTMENT TABLE  --> DEPARTMENT_ID / NAME / LOCATION 
  EMPLOYEE TABLE    --> DEPARTMENT_ID / SALARY / EMPLOYEE_ID */

--QUERY THAT WILL BE USED IN PL/SQL
SELECT
COALESCE(B.DEPARTMENT_ID,0) AS DEPARTMENT_ID
, COALESCE(B.NAME,'EXEC') AS DEPARTMENT_NAME
, COUNT(EMPLOYEE_ID) AS EMPS_PER_DEP
, SUM(SALARY) AS SUMSAL_PER_DEP
, CURRENT_TIMESTAMP AS LAST_LOAD_TS
FROM EMPLOYEE A
LEFT OUTER JOIN DEPARTMENT B
ON A.DEPARTMENT_ID = B.DEPARTMENT_ID
GROUP BY B.DEPARTMENT_ID, B.NAME;

--CREATING TARGET TABLE WITH ABOVE QUERY STRUCTURE
CREATE TABLE DEPT_DETAIL
( DEPARTMENT_ID NUMBER NOT NULL
, DEPARTMENT_NAME VARCHAR(20) NOT NULL
, EMPS_PER_DEP NUMBER
, SUMSAL_PER_DEP NUMBER
, LAST_LOAD_TS TIMESTAMP NOT NULL
, CONSTRAINT DEPT_DETAIL_PK PRIMARY KEY (DEPARTMENT_ID));


--START OF PROCEDURE
DECLARE     
    --DECLARATION OF FLAG VARIABLES
    INS_FLAG BOOLEAN;
    UPD_FLAG BOOLEAN;
    
    --DECLARATION OF CUROSR FOR CHECKING IF RECORDS EXIST IN TARGET TABLE
    CURSOR C1 IS 
        SELECT 
        B.DEPARTMENT_ID AS TGT_DEPT_ID
        FROM DEPARTMENT A 
        LEFT OUTER JOIN DEPT_DETAIL B
        ON A.DEPARTMENT_ID = b.department_id
        WHERE B.DEPARTMENT_ID IS NULL;
    V_ROW1 C1%ROWTYPE;
    
    --DECLARATION OF CURSOR FOR UPDATING RECORDS IN TARGET TABLE 
    CURSOR C1 IS
        SELECT
        COALESCE(B.DEPARTMENT_ID,0) AS DEPARTMENT_ID
        , COALESCE(B.NAME,'EXEC') AS DEPARTMENT_NAME
        , COUNT(EMPLOYEE_ID) AS EMPS_PER_DEP
        , SUM(SALARY) AS SUMSAL_PER_DEP
        , CURRENT_TIMESTAMP AS LAST_LOAD_TS
        FROM EMPLOYEE A
        LEFT OUTER JOIN DEPARTMENT B
        ON A.DEPARTMENT_ID = B.DEPARTMENT_ID
        GROUP BY B.DEPARTMENT_ID, B.NAME;
    V_ROW2 C2%ROWTYPE; 
    
    
BEGIN
    --OPENING CURSOR C1   
    OPEN C1;
        FETCH C1 INTO V_ROW1;
    CLOSE C1;
    
    -- SETTING THE INSERT FLAG/UPDATE FLAG TO DECIDE IF IT WILL BE AN INSERT OR AN UPDATE.
    IF V_ROW1.TGT_DEPT_ID IS NULL THEN INS_FLAG := TRUE;
    ELSE UPD_FLG := TRUE;
    END IF;
    
    --IF CONDITION TO ROUTE TO INSERT OP
    IF INS_FLAG = TRUE THEN
        INSERT INTO DEPT_DETAIL AS
            SELECT
            COALESCE(B.DEPARTMENT_ID,0) AS DEPARTMENT_ID
            , COALESCE(B.NAME,'EXEC') AS DEPARTMENT_NAME
            , COUNT(EMPLOYEE_ID) AS EMPS_PER_DEP
            , SUM(SALARY) AS SUMSAL_PER_DEP
            , CURRENT_TIMESTAMP AS LAST_LOAD_TS
            FROM EMPLOYEE A
            LEFT OUTER JOIN DEPARTMENT B
            ON A.DEPARTMENT_ID = B.DEPARTMENT_ID
            GROUP BY B.DEPARTMENT_ID, B.NAME;
    
    --ELSIF CONDITION TO ROUTE TO UPDATE OP 
    ELSIF UPD_FLAG = TRUE THEN
            --UPDATE STATEMENT FOR UPDATING INTO TARGET TABLE
            UPDATE DEPT_DETAIL D SET 
		(D.DEPARTMENT_ID
		, D.DEPARTMENT_NAME
		, D.EMPS_PER_DEP
		, D.SUMSAL_PER_DEP
		, D.LAST_LOAD_TS) 
		= (SELECT
       		 COALESCE(B.DEPARTMENT_ID,0) AS DEPARTMENT_ID
       		 , COALESCE(B.NAME,'EXEC') AS DEPARTMENT_NAME
       		 , COUNT(EMPLOYEE_ID) AS EMPS_PER_DEP
       		 , SUM(SALARY) AS SUMSAL_PER_DEP
       		 , CURRENT_TIMESTAMP AS LAST_LOAD_TS
       		 FROM EMPLOYEE A
       		 LEFT OUTER JOIN DEPARTMENT B
       		 ON A.DEPARTMENT_ID = B.DEPARTMENT_ID
       		 GROUP BY B.DEPARTMENT_ID, B.NAME);
    END IF;    
END;